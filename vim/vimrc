" =============================================================================
" VIM CONFIGURATION - Optimized for macOS 15 & Performance
" =============================================================================

" Use Vim settings, rather then Vi settings (much better!).
set nocompatible

source $DOTDOT/vim/plugins.vim

" remap the leader key.  typically \, but , is easier
let mapleader=","
" 2 second leader key (default is 1 sec)
set timeoutlen=2000

" Quickly edit/reload the vimrc file
nmap <silent> <leader>ev :e $MYVIMRC<CR>
nmap <silent> <leader>sv :w<CR>:so $MYVIMRC<CR>
nmap <silent> <leader>ep :e $DOTDOT/vim/plugins.vim<CR>
nmap <silent> <leader>sp :w<CR>:so $DOTDOT/vim/plugins.vim<CR>

" learn to do it correctly
noremap <Up> <Nop>
noremap <Down> <Nop>
noremap <Left> <Nop>
noremap <Right> <Nop>

" When started as "evim", evim.vim will already have done these settings.
if v:progname =~? "evim"
  finish
endif

" allow backspacing over everything in insert mode
set backspace=indent,eol,start

if has("vms") || has("mac")
  set nobackup
  autocmd filetype crontab setlocal nobackup nowritebackup
else
  set backup            " keep a backup file
  set backupdir=~/.tmp
  set directory=~/.tmp/swapfiles//
endif

set history=500         " keep 500 lines of command line history
set ruler               " show the cursor position all the time
set showcmd             " display incomplete commands
set incsearch           " do incremental searching

" persistent undo
set undofile
set undodir=~/.tmp/undo//
if !isdirectory(expand('~/.tmp/undo'))
    call mkdir(expand('~/.tmp/undo'), 'p')
endif

" ripgrep and fd don't need recursive paths, so keep this simple
set path=.,/usr/include,,

" Don't use Ex mode, use Q for formatting
map Q gq

" Switch syntax highlighting on
" This is an alternative that also works in block mode, but the deleted
" text is lost and it only works for putting the current register.
" vnoremap p "_dp

" Switch syntax highlighting on, when the terminal has colors
" Also switch on highlighting the last used search pattern.
if &t_Co > 2 || has("gui_running")
  syntax on
  set hlsearch
endif

" Conflict markers highlight
match ErrorMsg '\v^[<\|=|>]{7}([^=].+)?$'

" Autocommands
if has("autocmd")
    augroup vim
            au!
            au BufWritePost .vimrc source $MYVIMRC
    augroup END

    filetype on
    filetype indent plugin on

    augroup vimrcEx
        au!
        autocmd FileType text setlocal textwidth=99
        autocmd BufReadPost *
        \ if line("'\"") > 0 && line("'\"") <= line("$") |
        \   exe "normal g`\"" |
        \ endif
    augroup END

    set list
    set listchars=tab:▸\ ,trail:.,extends:#,nbsp:.,precedes:… ",eol:¬
else
  set autoindent
endif

set number
set encoding=utf8
set expandtab
set textwidth=0
set ai sw=4
set tabstop=4
set softtabstop=4
set shiftwidth=4
set autoindent
set ignorecase
set smartcase
set hidden
set lazyredraw
set ttyfast
set nocursorline
set nocursorcolumn
set scrolljump=5
set synmaxcol=180
set showmatch
set title
set visualbell
set noerrorbells

set colorcolumn=99
highlight ColorColumn ctermbg=lightgrey guibg=lightgrey

set fileformat=unix
set fileformats=unix,dos

set splitbelow
set splitright

set wildmenu
set wildmode=longest:full,list:full
set wildignore+=*.DS_Store,~*
set wildignore+=*.bmp,*.gif,*.jpg,*.png
set wildignore+=*/tmp/*,*.exe,*.dll,*.so,*.swp,*.zip,*.pyc
set wildignore+=*/.git/*,*/.hg/*,*/.svn/*
set wildignore+=*/.sass-cache/*,*/bower_components/*,*/node_modules/*,*/__pycache__/*,*venv*,*.tox*
set wildignore+=*/target/*

nnoremap j gj
nnoremap k gk

nmap <silent> ,/ :nohlsearch<CR>
map <silent><leader>\ :%s/\s\+$//<CR>:let @/=''<CR>
nmap <silent> <leader>sn :scriptnames<CR>
cmap w!! w !sudo tee % >/dev/null
nmap <leader>w :w!<cr>
nmap <leader>fq :q!<cr>
nmap <leader>rw :redraw!<cr>

vmap Q gq
nmap Q gqap

set foldmethod=indent
set foldlevel=10
set clipboard+=unnamedplus
nnoremap <space> za

command Bc bp\|bd \#
nnoremap <esc><esc> :nohl<cr>
nnoremap <Leader><Leader> :e#<CR>

" NerdTree
nnoremap <Leader>n :NERDTreeToggle<CR>
nnoremap <silent> <Leader>nv :NERDTreeFind<CR>
let NERDTreeMinimalUI = 1
let NERDTreeDirArrows = 1
let NERDTreeHighlightCursorline = 1
let NERDTreeIgnore = ['\~$', '.*\.pyc$', 'pip-log\.txt$', '__pycache__', '.*\.egg-info', 'node_modules']
let NERDChristmasTree = 1
let NERDTreeChDirMode = 2
let NERDTreeMapJumpFirstChild = 'gK'
let NERDTreeMapActivateNode='<space>'
let NERDTreeAutoDeleteBuffer = 1
autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif

vnoremap < <gv
vnoremap > >gv

nnoremap <Leader>+ <Plug>nextvalInc
nnoremap <Leader>- <Plug>nextvalDec

" --- Airline ---
set laststatus=2
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#fnamemod = ':t'
let g:airline#extensions#tabline#show_buffers = 1
let g:airline#extensions#tabline#tab_nr_type = 0
let g:airline#extensions#tabline#show_close_button = 0
let g:airline#extensions#tabline#buffer_nr_show = 1
let g:airline#extensions#tabline#buffer_idx_mode = 0
let g:airline_theme='luna'
let g:airline_powerline_fonts = 1
let g:airline#extensions#gutentags#enabled = 1
let g:airline#extensions#ale#enabled = 1

" --- Unified Gutentags Fix ---
let g:gutentags_add_default_project_roots = 1
let g:gutentags_project_root = ['.git', '.tags', 'package.json']
let g:gutentags_generate_on_missing = 1
let g:gutentags_generate_on_write = 1
let g:gutentags_resolve_symlinks = 1
let g:gutentags_ctags_tagfile = 'tags'

" Central cache to prevent 'returned: 1' error in project subdirs
let g:gutentags_cache_dir = expand('~/.cache/tags')
if !isdirectory(g:gutentags_cache_dir)
    call mkdir(g:gutentags_cache_dir, 'p')
endif

" Crucial: Force Universal Ctags path to stop macOS system ctags from crashing
if executable('/usr/local/bin/ctags')
    let g:gutentags_ctags_executable = '/usr/local/bin/ctags'
elseif executable('/opt/homebrew/bin/ctags')
    let g:gutentags_ctags_executable = '/opt/homebrew/bin/ctags'
endif

let g:gutentags_ctags_exclude = [
      \ 'node_modules', '.git', '.next', '.cache', 'dist', 'build',
      \ 'vendor', '*.md', '*-lock.json', '*.js.map', 'Library', 'target'
      \ ]

" Set vim tags to look in project AND the Gutentags cache
set tags=./tags;,tags;,~/.cache/tags/tags

nnoremap <leader>a :Rg<Space>

" html5/emmet
let g:html5_event_handler_attributes_complete = 1
let g:html5_microdata_attributes_complete = 1
let g:html5_rdfa_attributes_complete = 1
let g:html5_aria_attributes_complete = 1
let g:user_emmet_leader_key = '<c-e>'
let g:user_emmet_mode='a'
let g:user_emmet_expandabbr_key='<c-e>'
let g:use_emmet_complete_tag=1

" python-mode
let g:pymode_lint_ignore='E501'
let g:pymode_virtualenv = 1
let g:pymode_lint = 0
let g:pymode_rope = 0
let g:pymode_utils_whitespaces = 1
let g:pymode_indent = 1
let g:pymode_syntax = 1
let g:pymode_syntax_all = 1
let g:pymode_syntax_print_as_function = 0
let g:pymode_syntax_indent_errors = g:pymode_syntax_all
let g:pymode_syntax_space_errors = g:pymode_syntax_all
let g:pymode_syntax_string_formatting = g:pymode_syntax_all
let g:pymode_syntax_string_format = g:pymode_syntax_all
let g:pymode_syntax_string_templates = g:pymode_syntax_all
let g:pymode_syntax_doctests = g:pymode_syntax_all
let g:pymode_syntax_builtin_objs = g:pymode_syntax_all
let g:pymode_syntax_builtin_funcs = g:pymode_syntax_all
let g:pymode_syntax_highlight_exceptions = g:pymode_syntax_all
let python_highlight_all=1

" Ale
let g:ale_sign_column_always = 1
let g:ale_completion_enabled = 1
let g:ale_open_list = 0
let g:ale_set_highlights = 1
let g:ale_set_loclist = 1
let g:ale_echo_cursor = 1
let g:ale_keep_list_window_open = 0
let g:ale_lint_delay = 100
let g:ale_lint_on_insert_leave = 1
let g:ale_lint_on_save = 1
let g:ale_lint_on_text_changed = 'always'
let g:ale_cache_executable_check_failures = 1
let g:ale_echo_msg_error_str = 'E'
let g:ale_echo_msg_warning_str = 'W'
let g:ale_echo_msg_format = '[%linter%] %s [%severity%]'
let g:ale_lint_on_enter = 1
let g:airline#extensions#ale#enabled = 1
let airline#extensions#ale#show_line_numbers = 1
let g:ale_sign_error = '✗'
let g:ale_sign_warning = '⚠'

autocmd ColorScheme * highlight ALEErrorSign ctermbg=NONE ctermfg=red
autocmd ColorScheme * highlight ALEWarningSign ctermbg=NONE ctermfg=yellow

let g:ale_linters_explicit = 1
let g:ale_linters = {
\  'python': ['ruff', 'flake8', 'pylint-django', 'pylint'],
\  'javascript': ['eslint'],
\  'css': ['stylelint'],
\  'puppet': ['puppetlint', 'puppet'],
\  'markdown': ['pymarkdown'],
\}
let g:ale_linter_aliases = {'jsx': 'css'}
let g:ale_fixers = {
\   '*': ['remove_trailing_lines', 'trim_whitespace'],
\  'python': ['ruff', 'ruff_format', 'isort'],
\  'javascript': ['eslint', 'prettier'],
\  'vue': ['eslint'],
\  'scss': ['prettier'],
\  'css': ['prettier'],
\  'puppet': ['puppetlint', 'puppet'],
\  'markdown': ['pymarkdown'],
\}
let g:ale_python_mypy_options = '--namespace-packages --ignore-missing-imports'
let g:ale_puppet_puppetlint_options = '--no-autoloader_layout-check --no-double_quoted_strings-check --with-filename --no-trailing_whitepsace-check --no-arrow_alignment-check'
let g:ale_python_auto_virtualenv = 1

" Black
autocmd BufWritePre *.py execute ':Black'
nnoremap <Leader>b :Black<CR>

" fzf ------------------------------------------------------------
nnoremap <C-p> :Files<CR>

let g:fzf_action = {
      \ 'ctrl-t': 'tab split',
      \ 'ctrl-v': 'vsplit',
      \ 'ctrl-x': 'split',
      \ 'ctrl-a': 'argedit' }
let g:fzf_history_dir = '~/.local/share/fzf-history'
let g:fzf_buffers_jump = 1
let g:fzf_layout = {'up': '~40%'}

nnoremap <c-p><c-p> :Files<CR>
nnoremap <leader>t :Tags<cr>
nnoremap <leader>. :Tags<cr>
nnoremap <leader>b :Buffers<cr>
nnoremap <leader>m :Marks<cr>

" Silence Airline lag during FZF
autocmd! FileType fzf set laststatus=0 noshowmode noruler
  \| autocmd BufLeave <buffer> set laststatus=2 showmode ruler

" fzf ag integration
autocmd! VimEnter * command! -nargs=* -complete=file Ag :call s:fzf_ag_raw(<q-args>)
function! s:fzf_ag_raw(cmd)
  call fzf#vim#ag_raw('--noheading '. a:cmd)
endfunction

" Match FZF colors to Atelier_CaveDark
let g:fzf_colors =
\ { 'fg':      ['fg', 'Normal'],
  \ 'bg':      ['bg', 'Normal'],
  \ 'hl':      ['fg', 'Comment'],
  \ 'fg+':     ['fg', 'CursorLine', 'CursorColumn', 'Normal'],
  \ 'bg+':     ['bg', 'CursorLine', 'CursorColumn'],
  \ 'hl+':     ['fg', 'Statement'],
  \ 'info':    ['fg', 'PreProc'],
  \ 'border':  ['fg', 'Ignore'],
  \ 'prompt':  ['fg', 'Conditional'],
  \ 'pointer': ['fg', 'Exception'],
  \ 'marker':  ['fg', 'Keyword'],
  \ 'spinner': ['fg', 'Label'],
  \ 'header':  ['fg', 'Comment'] }
" ----------------------------------------------------------------

" Plug mappings
nnoremap <Leader>pu :PlugUpdate<CR>
nnoremap <Leader>pc :PlugClean<CR>
nnoremap <Leader>pi :PlugInstall<CR>
nnoremap <Leader>ps :PlugStatus<CR>

" GitGutter
set updatetime=100
set signcolumn=yes
let g:gitgutter_max_signs = 500

" Regex magic
nnoremap / /\v
nnoremap s/ s/\v
nnoremap %s/ %s/\v
vnoremap / /\v
vnoremap %s/ %s/\v

" Spell check
nnoremap <F2> :set spell<CR>
setlocal spell
highlight SpellBad term=standout ctermfg=1 term=underline cterm=underline cterm=italic
set spell spelllang=en_us
set dictionary+=/usr/share/dict/words
set spellfile=~/.vim/spell/en.utf-8.add

" Completion
set complete+=.,w,b,u,t,i
set complete+=kspell

" Master Visual Paste
xnoremap p "_d"0P
set showmode
set regexpengine=0

" Capitol aliases
command! W w
command! Wq wq
command! WQ wq
command! Q q
command! Bd bd
command! BD bd
command! Bn bn
command! BN bn
command! Bp bp
command! BP bp

colorscheme Atelier_CaveDark

" file based stuff
au BufNewFile,BufRead *.groovy,*.gradle setf groovy
autocmd! BufEnter,BufNewFile *.groovy,*.java,*.gradle,*.scala,*.sbt colo elflord
autocmd! BufLeave *.groovy,*.java,*.gradle,*.scala,*.sbt colo oceandeep

augroup javascript_folding
    au!
    au FileType javascript setlocal foldmethod=syntax
augroup END
let g:javascript_plugin_jsdoc = 1

" powerline
set rtp+=$DOTDOT/vim/vim/bundle/powerline/powerline/bindings/vim

nnoremap <leader>l :lcl<CR>

if &term =~ "xterm"
    let &t_Co=256
    set t_ti=ESC7ESC[rESC[?47h t_te=ESC[?47lESC8
    if has("terminfo")
        let &t_Sf="\ESC[3%p1%dm"
        let &t_Sb="\ESC[4%p1%dm"
    else
        let &t_Sf="\ESC[3%dm"
        let &t_Sb="\ESC[4%dm"
    endif
endif

if exists('$TMUX')
    let &t_SI = "\<Esc>Ptmux;\<Esc>\<Esc>]50;CursorShape=1\x7\<Esc>\\"
    let &t_EI = "\<Esc>Ptmux;\<Esc>\<Esc>]50;CursorShape=0\x7\<Esc>\\"
else
    let &t_SI = "\<Esc>]50;CursorShape=1\x7"
    let &t_EI = "\<Esc>]50;CursorShape=0\x7"
endif

" Django
au BufNewFile,BufRead admin.py,urls.py,models.py,views.py,settings.py,forms.py setlocal filetype=python.django
autocmd filetype python nnoremap <buffer> <leader>ib :normal oimport pdb; pdb.set_trace()  # TODO: BREAKPOINT  # noqa<Esc>

" Jedi
let g:jedi#popup_on_dot = 0
let g:jedi#popup_select_first = 0
let g:jedi#usages_command = "<leader>b"

" Completor logic
function! Tab_Or_Complete() abort
  if pumvisible()
    return "\<C-N>"
  elseif col('.')>1 && strpart( getline('.'), col('.')-2, 3 ) =~ '^\w'
    return "\<C-R>=completor#do('complete')\<CR>"
  else
    return "\<Tab>"
  endif
endfunction

inoremap <expr> <Tab> pumvisible() ? "\<C-n>" : "\<Tab>"
inoremap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"
let g:completor_auto_trigger = 1
inoremap <expr> <Tab> Tab_Or_Complete()

let g:scala_sort_across_groups=1
let g:scala_first_party_namespaces='\(controllers\|views\|models\|modules\|util.\|gov.\)'

au FileType html,css,markdown,htmldjango,scsshp,txt setlocal binary noeol et ts=2 sts=2 sw=2
if exists("nofixeol")
    au FileType html,css,markdown,htmldjango,scsshp,txt setlocal binary noeol nofixeol
endif

au FileType scala syn region foldImports start="import" end=/import.*\n^$/ fold keepend

au BufNewFile,BufRead *.pp
  \ set filetype=puppet |
  \ set tabstop=2 |
  \ set softtabstop=2 |
  \ set shiftwidth=2 |
  \ set textwidth=79 |
  \ set expandtab |
  \ set autoindent |
  \ set fileformat=unix

au FileType puppet setlocal isk+=:
au FileType puppet nnoremap <c-]> :exe "tag " . substitute(expand("<cword>"), "^::", "", "")<CR>
au FileType puppet nnoremap <c-w><c-]> :tab split<CR>:exe "tag " . substitute(expand("<cword>"), "^::", "", "")<CR>

autocmd BufNewFile,BufReadPost *.md set filetype=markdown
autocmd BufRead,BufNewFile *.md setlocal spell
autocmd FileType gitcommit setlocal spell
highlight Comment cterm=italic

let g:tagbar_type_puppet = {
  \ 'ctagstype': 'puppet',
  \ 'kinds': ['c:class','s:site','n:node','d:definition','r:resource','f:default']
\}

" Astro
let g:tagalong_additional_filetypes = ['astro']
